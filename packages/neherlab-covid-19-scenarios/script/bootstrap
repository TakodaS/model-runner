#!/bin/bash

set -e

: ${BASEL_REPO:=../../../covid19_scenarios}

if [ ! -d $BASEL_REPO ]; then
cat <<MESSAGE
Set the 'BASEL_REPO' to the path to the Basel model repository,
or check out the repository to ../../../covid19_scenarios
For now we recommend you check out this fork and branch:
https://github.com/adityasharad/covid19_scenarios/tree/unified-ui-cli
MESSAGE
exit 1
fi

# Build the Basel model schema
pushd $BASEL_REPO
echo "Installing Basel model dependencies"
yarn install --frozen-lockfile --ignore-scripts
echo "Installed Basel model dependencies"
echo "Compiling the Basel model schema"
yarn schema:clean
yarn schema:totypes
echo "Compiled the Basel model schema"
popd

# Create an executable with a hardcoded path to the model repo
rm -rf .local/bin
mkdir -p .local/bin
BASEL_REPO_PATH="$(readlink -f $BASEL_REPO)"
LOCAL_EXEC_PATH=.local/bin/run-basel-model
sed -e "s|\$MODEL_REPO_ROOT|$BASEL_REPO_PATH|g" bin/run-basel-model > $LOCAL_EXEC_PATH
chmod +x $LOCAL_EXEC_PATH
echo "Wrote a local executable script to $LOCAL_EXEC_PATH"

# Copy Basel data for local runs
mkdir -p data/basel
cp $BASEL_REPO_PATH/src/assets/data/scenarios.json data/
echo "Copied model data"